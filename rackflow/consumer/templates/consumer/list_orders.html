{% extends "base.html" %} {% load static %} {% block content %}

<div class="flex flex-1 justify-center w-full">
  <div class="container mx-auto flex flex-col flex-1 py-4">
    <div class="flex items-center gap-4 p-4 mb-12">
      <a href="{% url 'product:list' %}">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6"
          viewBox="0 0 448 512"
        >
          <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
          <path
            d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"
          />
        </svg>
      </a>

      <p
        class="text-black text-center md:text-left tracking-light text-[32px] font-bold leading-tight relative expand-underline"
      >
        Orders
      </p>
    </div>

    <div class="px-4 py-3">
      <div
        class="flex overflow-auto rounded-lg border border-[#e9e1ce] bg-[#fcfbf8]"
      >
        <table class="flex-1 text-center md:text-left min-w-[1000px] overflow-x-auto">
          <thead>
            <tr class="bg-[#fcfbf8]">
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Order number
              </th>
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Owner
              </th>
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Consumer
              </th>
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Date
              </th>
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Status
              </th>
              <th
                class="px-4 py-3 text-center md:text-left text-dark text-sm font-medium leading-normal"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr class="border-t border-t-[#e9e1ce]">
              <td
                class="h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal"
              >
                Order #{{order.id}}
              </td>
              <td
                class="h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal"
              >
                {{order.user.first_name}} {{order.user.last_name}}
              </td>
              <td
                class="h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal"
              >
                {{order.consumer.name}}
              </td>
              <td
                class="h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal"
              >
                {{order.c_date}}
              </td>
              <td
                id = "status-{{ order.id }}"
                class="h-[72px] px-4 py-2 {% if order.status == 'pending' %} text-[var(--primary-dark)] {%elif order.status == 'accepted'%} text-green-500 {%else%} text-red-500 {%endif%} text-sm font-normal leading-normal capitalize"
              >
                {{order.status}}
              </td>
              <td
                class="h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal flex items-center gap-6"
              >

              <div id="actions-{{ order.id }}" class="flex items-center gap-6">
                {% if order.status == 'pending' and user.is_superuser %}
                <button onclick="sendStatusUpdate({{ order.id }}, 'accepted')"
                        class="py-1 px-3 rounded border border-[var(--primary-dark)]">
                  Accept
                </button>
                <button onclick="sendStatusUpdate({{ order.id }}, 'rejected')"
                        class="py-1 px-3 rounded border border-[var(--primary-dark)]">
                  Reject
                </button>
                {% endif %}
                <a href="{% url 'consumer:details' order.id%}" class="py-1 px-3 rounded border border-[var(--primary-dark)]">Details</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
{% block script %}
<script>
    
    pending_classes = "h-[72px] px-4 py-2 text-[var(--primary-dark)] text-sm font-normal leading-normal capitalize"
    accepted_classes = "h-[72px] px-4 py-2 text-green-500 text-sm font-normal leading-normal capitalize"
    rejected_classes = "h-[72px] px-4 py-2 text-red-500 text-sm font-normal leading-normal capitalize"

    function sendStatusUpdate(orderId, status) {
      fetch(`/consumer/api/orders/${orderId}/status/`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({ status: status })
      })
      .then(response => {
        if (response.ok) {
          // Update status text and style
          const td = document.getElementById(`status-${orderId}`);
          td.innerHTML = status.charAt(0).toUpperCase() + status.slice(1);
          td.className = status === "accepted" ? accepted_classes :
                         status === "rejected" ? rejected_classes :
                         pending_classes;

          // Keep only the Details button
          const actionsDiv = document.getElementById(`actions-${orderId}`);
          const detailsButton = actionsDiv.querySelector("a");
          actionsDiv.innerHTML = "";
          actionsDiv.appendChild(detailsButton);
        } else {
          return response.json().then(data => {
            alert("Failed to update: " + (data.detail || response.status));
          });
        }
      })
      .catch(err => {
        alert("Request failed: " + err);
      });
    }

  // Get CSRF token from cookie (for Django CSRF protection)
  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        return decodeURIComponent(cookie.slice(name.length + 1));
      }
    }
    return '';
  }
</script>

{% endblock script %}
